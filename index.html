<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶å UCSC Wildlife Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .map-container {
            height: calc(100vh - 2rem);
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
        }
        .expire-warning {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const API_URL = 'https://ucsc-animals.onrender.com/api';
        
        const ANIMALS = [
            { id: 'deer', label: 'Deer', emoji: 'ü¶å', color: '#8B4513' },
            { id: 'turkey', label: 'Turkey', emoji: 'ü¶É', color: '#654321' },
            { id: 'cow', label: 'Cow', emoji: 'üêÑ', color: '#2F4F4F' },
            { id: 'sheep', label: 'Sheep', emoji: 'üêë', color: '#696969' },
            { id: 'goat', label: 'Goat', emoji: 'üêê', color: '#556B2F' },
            { id: 'coyote', label: 'Coyote', emoji: 'üê∫', color: '#8B0000' }
        ];

        const UCSC_CENTER = { lat: 36.9916, lng: -122.0583 };
        const HOUR_IN_MS = 3600000;

        function WildlifeTracker() {
            const [sightings, setSightings] = React.useState([]);
            const [userLocation, setUserLocation] = React.useState(null);
            const [showAddForm, setShowAddForm] = React.useState(false);
            const [error, setError] = React.useState('');
            const [map, setMap] = React.useState(null);
            const [markers, setMarkers] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [selectedImage, setSelectedImage] = React.useState(null);
            const [imagePreview, setImagePreview] = React.useState(null);

            React.useEffect(() => {
                fetchSightings();
                initializeMap();
                // Check for expired sightings every minute
                const interval = setInterval(checkExpiredSightings, 60000);
                return () => clearInterval(interval);
            }, []);

            const checkExpiredSightings = async () => {
                const now = new Date().getTime();
                const expired = sightings.filter(sighting => {
                    const lastUpdate = new Date(sighting.lastUpdate || sighting.timestamp).getTime();
                    return (now - lastUpdate) > HOUR_IN_MS;
                });

                if (expired.length > 0) {
                    try {
                        await Promise.all(expired.map(sighting => 
                            fetch(`${API_URL}/sightings/${sighting._id}`, { method: 'DELETE' })
                        ));
                        fetchSightings();
                    } catch (err) {
                        console.error('Error deleting expired sightings:', err);
                    }
                }
            };

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        setError('Image must be smaller than 5MB');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setSelectedImage(file);
                        setImagePreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleStillHere = async (sightingId) => {
                try {
                    const response = await fetch(`${API_URL}/sightings/${sightingId}/refresh`, {
                        method: 'POST'
                    });
                    if (!response.ok) throw new Error('Failed to refresh sighting');
                    fetchSightings();
                } catch (err) {
                    setError('Failed to update sighting: ' + err.message);
                }
            };

            // Rest of your existing functions (fetchSightings, initializeMap, etc.)
            // Modified handleSubmit to include image upload
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedImage) {
                    setError('Please add a photo of the animal');
                    return;
                }

                const formData = new FormData(e.target);
                formData.append('image', selectedImage);
                formData.append('location', JSON.stringify(userLocation));

                try {
                    const response = await fetch(`${API_URL}/sightings`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error('Failed to save sighting');
                    
                    const savedSighting = await response.json();
                    setSightings([savedSighting, ...sightings]);
                    setShowAddForm(false);
                    setUserLocation(null);
                    setSelectedImage(null);
                    setImagePreview(null);
                } catch (err) {
                    setError('Failed to save sighting: ' + err.message);
                }
            };

            // Modify your existing form JSX to include these new elements
            return (
                <div className="max-w-7xl mx-auto p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            {/* Your existing header */}
                            
                            {showAddForm && (
                                <form onSubmit={handleSubmit} className="space-y-4 mb-6 bg-gray-50 p-4 rounded-lg">
                                    {/* Existing form fields */}
                                    
                                    <div>
                                        <label className="block mb-2">üì∏ Photo</label>
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={handleImageChange}
                                            required
                                            className="w-full p-2 border rounded-lg"
                                        />
                                        {imagePreview && (
                                            <img 
                                                src={imagePreview} 
                                                alt="Preview" 
                                                className="mt-2 image-preview rounded"
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Rest of your form */}
                                </form>
                            )}

                            <div className="space-y-4">
                                <h3 className="text-lg font-semibold">üìù Recent Sightings</h3>
                                {loading ? (
                                    <div className="text-center py-4">Loading...</div>
                                ) : sightings.length === 0 ? (
                                    <p className="text-gray-500">üëÄ No sightings reported yet</p>
                                ) : (
                                    sightings.map(sighting => {
                                        const timeSinceUpdate = new Date().getTime() - new Date(sighting.lastUpdate || sighting.timestamp).getTime();
                                        const minutesRemaining = Math.floor((HOUR_IN_MS - timeSinceUpdate) / 60000);
                                        const isExpiringSoon = minutesRemaining < 10;

                                        return (
                                            <div
                                                key={sighting._id}
                                                className={`p-4 border rounded-lg hover:bg-gray-50 ${isExpiringSoon ? 'expire-warning' : ''}`}
                                            >
                                                <div className="flex items-start justify-between">
                                                    <div>
                                                        <h4 className="font-medium">
                                                            {ANIMALS.find(a => a.id === sighting.animal)?.emoji} 
                                                            {ANIMALS.find(a => a.id === sighting.animal)?.label}
                                                            {sighting.isBaby && ' üçº'}
                                                        </h4>
                                                        <p className="text-sm text-gray-600">
                                                            üïí {new Date(sighting.timestamp).toLocaleString()}
                                                        </p>
                                                        <p className="text-sm text-gray-600">
                                                            ‚è≥ Expires in {minutesRemaining} minutes
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => handleStillHere(sighting._id)}
                                                        className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                                                    >
                                                        Still Here! üëã
                                                    </button>
                                                </div>
                                                <img 
                                                    src={sighting.imageUrl} 
                                                    alt="Wildlife sighting" 
                                                    className="mt-2 image-preview rounded"
                                                />
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>

                        <div className="map-container">
                            <div id="map" style={{ width: '100%', height: '100%' }}></div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<WildlifeTracker />, document.getElementById('root'));
    </script>
</body>
</html>