<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶å UCSC Animal Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdhSLa0IEty5AaakvM-gBTGhgAcvF4OJA"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .map-container {
            height: calc(100vh - 2rem);
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            object-fit: cover;
        }
        #cameraPreview {
            max-width: 100%;
            max-height: 300px;
            background-color: #000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        import React, { useState, useEffect, useRef } from 'react';
        import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

        const API_URL = 'https://ucsc-animals.onrender.com/api'; // Replace with your actual backend URL
        
        const ANIMALS = [
            { id: 'deer', label: 'Deer', emoji: 'ü¶å', color: '#8B4513' },
            { id: 'turkey', label: 'Turkey', emoji: 'ü¶É', color: '#654321' },
            { id: 'cow', label: 'Cow', emoji: 'üêÑ', color: '#2F4F4F' },
            { id: 'sheep', label: 'Sheep', emoji: 'üêë', color: '#696969' },
            { id: 'goat', label: 'Goat', emoji: 'üêê', color: '#556B2F' },
            { id: 'coyote', label: 'Coyote', emoji: 'üê∫', color: '#8B0000' }
        ];

        const UCSC_CENTER = { lat: 36.9916, lng: -122.0583 };

        const createMarkerIcon = (emoji) => ({
            url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 42 42" width="42" height="42">
                    <circle cx="21" cy="21" r="20" fill="white" stroke="#666666" stroke-width="2"/>
                    <text x="21" y="21" text-anchor="middle" dominant-baseline="central" font-size="20px">${emoji}</text>
                </svg>
            `)}`,
            size: new google.maps.Size(42, 42),
            anchor: new google.maps.Point(21, 21),
            scaledSize: new google.maps.Size(42, 42)
        });

        const formatRelativeTime = (timestamp) => {
    const now = new Date();
    const past = new Date(timestamp);
    const diffInSeconds = Math.floor((now - past) / 1000);
    
    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
    }
    
    const hours = Math.floor(diffInSeconds / 3600);
    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
};

const CameraComponent = ({ onImageCaptured, onError }) => {
    const videoRef = useRef(null);
    const [stream, setStream] = useState(null);
    const [error, setError] = useState(null);

    useEffect(() => {
        initializeCamera();
        
        // Cleanup function
        return () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    }, []);

    const CameraComponent = ({ onImageCaptured, onError }) => {
    const videoRef = useRef(null);
    const [stream, setStream] = useState(null);
    const [error, setError] = useState(null);

    useEffect(() => {
        initializeCamera();
        
        // Cleanup function
        return () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    }, []);

    const initializeCamera = async () => {
        try {
            if (!navigator.mediaDevices?.getUserMedia) {
                throw new Error('Camera API not supported');
            }

            const mediaStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });

            setStream(mediaStream);
            
            if (videoRef.current) {
                videoRef.current.srcObject = mediaStream;
                await videoRef.current.play();
            }

        } catch (err) {
            console.error('Camera initialization error:', err);
            setError(err.message);
            onError?.(err.message);
        }
    };

    const capturePhoto = () => {
        if (!videoRef.current) return;

        const canvas = document.createElement('canvas');
        canvas.width = videoRef.current.videoWidth;
        canvas.height = videoRef.current.videoHeight;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoRef.current, 0, 0);

        canvas.toBlob((blob) => {
            const file = new File([blob], 'wildlife-photo.jpg', { type: 'image/jpeg' });
            onImageCaptured(file);
            
            // Stop the camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }, 'image/jpeg', 0.8);
    };

    if (error) {
        return (
            <div className="p-4 bg-red-50 rounded-lg">
                <p className="text-red-600">Camera error: {error}</p>
                <button 
                    onClick={initializeCamera}
                    className="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                >
                    Try Again
                </button>
            </div>
        );
    }

    return (
        <div className="relative">
            <video
                ref={videoRef}
                autoPlay
                playsInline
                className="w-full h-64 object-cover rounded-lg bg-black"
            />
            <button
                onClick={capturePhoto}
                className="absolute bottom-4 left-1/2 transform -translate-x-1/2 
                         bg-green-500 hover:bg-green-600 text-white 
                         px-6 py-3 rounded-full shadow-lg"
            >
                üì∏ Take Photo
            </button>
        </div>
    );
}
};


        function WildlifeTracker() {
            const [sightings, setSightings] = React.useState([]);
            const [userLocation, setUserLocation] = React.useState(null);
            const [showAddForm, setShowAddForm] = React.useState(false);
            const [error, setError] = React.useState('');
            const [map, setMap] = React.useState(null);
            const [markers, setMarkers] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [imageFile, setImageFile] = React.useState(null);
            const [imagePreview, setImagePreview] = React.useState(null);
            const [cameraStream, setCameraStream] = React.useState(null);
            const [cameraError, setCameraError] = React.useState(null);

            const handleImageCapture = (file) => {
        setImageFile(file);
        setImagePreview(URL.createObjectURL(file));
        setCameraStream(null);
    };

    const handleCameraError = (errorMessage) => {
        setError(errorMessage);
        setCameraStream(null);
    };

            React.useEffect(() => {
                // Initialize map
                const mapInstance = new google.maps.Map(document.getElementById('map'), {
                    center: UCSC_CENTER,
                    zoom: 14,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });
                setMap(mapInstance);

                // Fetch initial sightings
                fetchSightings();
            }, []);

            const fetchSightings = async () => {
                try {
                    const response = await fetch(`${API_URL}/sightings`);
                    if (!response.ok) throw new Error('Failed to fetch sightings');
                    const data = await response.json();
                    setSightings(data);
                } catch (err) {
                    setError('Failed to load sightings');
                } finally {
                    setLoading(false);
                }
            };

            

            React.useEffect(() => {
                if (map && sightings.length > 0) {
                    updateMapMarkers();
                }
            }, [sightings, map]);

            const updateMapMarkers = () => {
                // Clear existing markers
                markers.forEach(marker => marker.setMap(null));
                
                const newMarkers = sightings.map(sighting => {
                    const animal = ANIMALS.find(a => a.id === sighting.animal);
                    const emoji = animal.emoji + (sighting.isBaby ? 'üçº' : '');
                    
                    const marker = new google.maps.Marker({
                        position: sighting.location,
                        map: map,
                        icon: createMarkerIcon(emoji),
                        title: `${animal.label}${sighting.isBaby ? ' (Baby)' : ''}`
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="p-2">
                                <h3 class="text-lg font-bold">${emoji} ${animal.label}${sighting.isBaby ? ' (Baby)' : ''}</h3>
                                <p class="text-sm">üïí ${new Date(sighting.timestamp).toLocaleString()}</p>
                            </div>
                        `
                    });

                    marker.addListener('click', () => infoWindow.open(map, marker));
                    return marker;
                });

                setMarkers(newMarkers);
            };
            const startCamera = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment', 
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        // Use a more robust method to find the video element
        const findVideoElement = () => {
            const videoElement = document.getElementById('cameraPreview');
            
            if (videoElement) {
                try {
                    videoElement.srcObject = stream;
                    
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().catch(playErr => {
                            console.error('Error playing video:', playErr);
                            setError(`Could not play video: ${playErr.message}`);
                        });
                    };
                    
                    setCameraStream(stream);
                } catch (err) {
                    console.error('Error setting video source:', err);
                    setError(`Could not set video source: ${err.message}`);
                }
            } else {
                console.error('Video element not found, retrying...');
                // Retry finding the element
                setTimeout(findVideoElement, 100);
            }
        };
        
        findVideoElement();
    } catch (err) {
        console.error('Camera access error:', err);
        setError(`Could not access camera: ${err.message}`);
    }
};

            const captureImage = () => {
                if (!cameraStream) return;

                const videoElement = document.getElementById('cameraPreview');
                const canvasElement = document.createElement('canvas');
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                const context = canvasElement.getContext('2d');
                context.drawImage(videoElement, 0, 0);
                
                // Stop camera stream
                cameraStream.getTracks().forEach(track => track.stop());
                setCameraStream(null);

                // Convert canvas to blob
                canvasElement.toBlob((blob) => {
                    const file = new File([blob], 'wildlife-sighting.jpg', { type: 'image/jpeg' });
                    setImageFile(file);
                    setImagePreview(URL.createObjectURL(file));
                }, 'image/jpeg');
            };

            const getCurrentLocation = () => {
        if (!navigator.geolocation) {
            setError('Geolocation is not supported by your browser');
            return;
        }

        setError('');
        setShowAddForm(true);

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                setUserLocation(location);
                map.panTo(location);
                map.setZoom(17);
                
                // Start camera after location is obtained
                setCameraStream(true);
            },
            () => {
                setError('Unable to get your location');
                setShowAddForm(false);
            }
        );
    };

const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Validate image
    if (!imageFile) {
        setError('Please capture an image');
        return;
    }

    const formData = new FormData();
    const sightingData = {
        animal: e.target.animal.value,
        isBaby: e.target.isBaby.value === 'true',
        location: userLocation,
    };
    
    formData.append('data', JSON.stringify(sightingData));
    formData.append('image', imageFile);
    
    try {
        const response = await fetch(`${API_URL}/sightings`, {
            method: 'POST',
            body: formData,
        });
        
        if (!response.ok) throw new Error('Failed to save sighting');
        
        const savedSighting = await response.json();
        setSightings([savedSighting, ...sightings]);
        setShowAddForm(false);
        setUserLocation(null);
        setImageFile(null);
        setImagePreview(null);
    } catch (err) {
        setError('Failed to save sighting');
    }
};

            const handleStillHere = async (sightingId) => {
    try {
        const response = await fetch(`${API_URL}/sightings/${sightingId}/still-here`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) throw new Error('Failed to update sighting');
        
        // Update the sightings list with the updated sighting
        const updatedSighting = await response.json();
        setSightings(sightings.map(sighting => 
            sighting._id === sightingId ? updatedSighting : sighting
        ));
    } catch (err) {
        setError('Failed to mark sighting as still here');
    }
};

            return (
                <div className="max-w-7xl mx-auto p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <div className="flex items-center justify-between mb-6">
                                    <div className="flex items-center gap-2">
                                        <span className="text-2xl">ü¶å</span>
                                        <span className="text-xl font-bold">UCSC Animal Tracker</span>
                                    </div>
                                    <button
                                        onClick={getCurrentLocation}
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"
                                    >
                                        <span>üìç</span> Add Sighting
                                    </button>
                                </div>

                                {error && (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                        {error}
                                    </div>
                                )}
                                {cameraStream && !imagePreview && (
                <CameraComponent
                    onImageCaptured={handleImageCapture}
                    onError={handleCameraError}
                />
            )}
            
            {imagePreview && (
                <div className="relative">
                    <img 
                        src={imagePreview} 
                        alt="Captured wildlife" 
                        className="w-full h-64 object-cover rounded-lg"
                    />
                    <button
                        type="button"
                        onClick={() => {
                            setImagePreview(null);
                            setImageFile(null);
                            setCameraStream(true);
                        }}
                        className="absolute bottom-4 left-1/2 transform -translate-x-1/2 
                                 bg-red-500 hover:bg-red-600 text-white 
                                 px-6 py-3 rounded-full shadow-lg"
                    >
                        ‚Ü∫ Retake Photo
                    </button>
                </div>
            )}
                                {showAddForm && (
                                    <form onSubmit={handleSubmit} className="space-y-4 mb-6 bg-gray-50 p-4 rounded-lg">
                                        <div className="flex justify-between items-start">
                                            <h3 className="text-lg font-semibold">üÜï New Sighting</h3>
                                            <button
                                                type="button"
                                                onClick={() => setShowAddForm(false)}
                                                className="text-gray-500 hover:text-gray-700"
                                            >
                                                ‚ùå
                                            </button>
                                        </div>
                                        
                                        
                                        <div>
                                            <label className="block mb-2">ü¶í Animal</label>
                                            <select
                                                name="animal"
                                                required
                                                className="w-full p-2 border rounded-lg"
                                            >
                                                {ANIMALS.map(animal => (
                                                    <option key={animal.id} value={animal.id}>
                                                        {animal.emoji} {animal.label}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block mb-2">üë∂ Age</label>
                                            <select
                                                name="isBaby"
                                                className="w-full p-2 border rounded-lg"
                                            >
                                                <option value="false">ü¶ä Adult</option>
                                                <option value="true">üçº Baby</option>
                                            </select>
                                        </div>

                                        {userLocation ? (
                                            <div className="text-sm text-gray-600">
                                                üìç Location: {userLocation.lat.toFixed(6)}, {userLocation.lng.toFixed(6)}
                                            </div>
                                        ) : (
                                            <div className="text-sm text-gray-600 animate-pulse">
                                                üì± Getting your location...
                                            </div>
                                        )}

                                        <button
                                            type="submit"
                                            disabled={!userLocation}
                                            className={`w-full px-4 py-2 rounded-lg ${
                                                userLocation 
                                                    ? 'bg-green-500 hover:bg-green-600 text-white' 
                                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            }`}
                                        >
                                            {userLocation ? '‚úÖ Submit Sighting' : '‚è≥ Waiting for location...'}
                                        </button>
                                    </form>
                                )}

                                <div className="space-y-4">
                                    <h3 className="text-lg font-semibold">üìù Recent Sightings</h3>
                                    {loading ? (
                                        <div className="text-center py-4">Loading...</div>
                                    ) : sightings.length === 0 ? (
                                        <p className="text-gray-500">üëÄ No sightings reported yet</p>
                                    ) : (
                                        sightings.map(sighting => (
                                            <div
        key={sighting._id}
        className="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer flex justify-between items-center"
        onClick={() => {
            map.panTo(sighting.location);
            map.setZoom(17);
        }}
    >
    <div
        key={sighting._id}
        className="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer flex"
        onClick={() => {
            map.panTo(sighting.location);
            map.setZoom(17);
        }}
    >
        <img 
            src={sighting.imageUrl} 
            alt={`${sighting.animal} sighting`} 
            className="w-24 h-24 object-cover rounded-lg mr-4"
        />
        <div>
            <h4 className="font-medium">
                {ANIMALS.find(a => a.id === sighting.animal)?.emoji} 
                {ANIMALS.find(a => a.id === sighting.animal)?.label}
                {sighting.isBaby && ' üçº'}
            </h4>
            <p className="text-sm text-gray-600">
                üïí {formatRelativeTime(sighting.timestamp)}
            </p>
            <p className="text-sm text-gray-600">
                üìç {sighting.location.lat.toFixed(6)}, {sighting.location.lng.toFixed(6)}
            </p>
        </div>
    </div>
        <button
            onClick={(e) => {
                e.stopPropagation(); // Prevent map pan when clicking the button
                handleStillHere(sighting._id);
            }}
            className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm"
        >
            Still Here
        </button>
    </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="map-container">
                            <div id="map" style={{ width: '100%', height: '100%' }}></div>
                        </div>
                    </div>
                </div>
            );
        }

        

        ReactDOM.render(<WildlifeTracker />, document.getElementById('root'));
    </script>
</body>
</html>
